(function(t,e){if(typeof define==="function"&&define.amd){define(["underscore","q","exports"],function(r,n,i){t.Utensils=e(t,i,r,n)})}else if(typeof exports!=="undefined"){var r=require("underscore");var n=require("q");e(t,exports,r)}else{t.Utensils=e(t,{},t._,t.Q)}})(this,function(t,e,r,n){var i=t.Utensils;e.VERSION="0.1.0";e.noConflict=function(){t.Utensils=i;return this};var u=e.Base=function(){var t=this;var e=r.toArray(arguments);var n=r.result(this,"argumentName");if(r.isString(n)&&r.isUndefined(this.argumentNames))this.argumentNames=[n];this.arguments=r.object(this.argumentNames,e);Object.freeze(this.arguments);if(this.argumentNames){r.each(e,function(e,r){t[t.argumentNames[r]]=e})}};u.extend=m;var s=e.Value=u.extend({argumentName:"value",valueOf:function(){return this[this.argumentName]}});s.isEqualTo=function(t,e){return t.valueOf()===e.valueOf()};s.isNotEqualTo=function(t,e){return t.valueOf()!==e.valueOf()};var o=["isEqualTo","isNotEqualTo"];r.each(o,function(t){s.prototype[t]=function(){return r.partial(s[t],this).apply(this,arguments)}});var a=e.Service=u.extend({constructor:function(){u.prototype.constructor.apply(this,arguments);var t=r.functions(this.constructor.__protoProps__);if(t.length===1){this.procedure=t}this.procedureMethods=v(this.procedure)},run:function(){var t=this;return d(this.procedureMethods).then(this.success).fail(this.error)}});var c=e.Form=u.extend({argumentName:"data",process:function(){return this.run.apply(this,arguments)},procedure:["validate","process"],run:function(){var t=this;if(this.validator){this.validate=function(){return new t.validator(t[t.argumentNames[0]]).run()}}if(this.processor){this.process=function(){return new t.processor(t.argumentNames[0]).run()}}var e=v(this.procedure);return d(e).then(this.success).fail(this.error)}});var l=e.Validator=u.extend({argumentName:"data",validate:function(){return this.run.apply(this,arguments)},run:function(){var t=this;var e=this.prepareProcedureMethods(r.functions(this.constructor.__protoProps__));var i=utilities.returnArrayOfResultsFromExecutedFunctions(e);return n.allSettled(i).then(this.parseResults)},prepareProcedureMethods:function(t){var e;e=utilities.getObjectMethodsByName(t,this);e=utilities.wrapAnySyncFunctionsWithBooleanPromiseHandling(e,this);e=utilities.wrapAnySequenceFunctionsThatRequestedPromises(e,this,{sequence:false,reject:function(t,e){return function(r){return e({name:t._name,error:r})}}});e=utilities.returnBoundObjectMethods(e,this);return e},parseResults:function(t){var e=n.defer();var i=t[0];var u=r.chain(t).filter(function(t){return t.state==="rejected"}).map(function(t){return t.reason}).value();if(u.length>0){e.reject(u)}else{e.resolve()}return e.promise}});var h=u.extend({perform:function(){return this.run.apply(this,arguments)},run:function(){var t=this;var e=v(this.procedure);return this.setup().then(function(){return d(e).then(t.success).fail(t.error)})},setup:function(){var t=this;return this.db().then(function(t){return t}).then(function(e){return t.buildCollections(e)})},buildCollections:function(t){var e=this;this.collections={};var i=r.map(this.collectionNames,function(r){return n.ninvoke(t,"collection",r).then(function(t){e.collections[r]=t})});return n.all(i)}});var f=e.Presenter=e.View=u.extend({constructor:function(t){this.data=r.isArray(t)?t:[t];r.each(this.data,Object.freeze)},present:function(){return this.run.apply(this,arguments)},run:function(t){var e=this;this.returnKeys=t;r.bindAll(this,"results","_whitelist","_blacklist","_propertyMap","_customAttributes");var i=r.map(this.data,function(t){return n(e.runOne(t))});return n.all(i).then(this.results)},runOne:function(t){var e=this;var i=r.clone(t);var u=n.defer();i=r.compose(u.resolve,function(n){return r.extend(n,e._customAttributes(t))},this._propertyMap,this._blacklist,this._whitelist)(i);return u.promise},results:function(t){var e=this;if(this.returnKeys){t=r.map(t,function(t){return r.pick.call(null,t,e.returnKeys)})}if(r.isArray(this.data)){return t}else{return t[0]}},_whitelist:function(t){if(!this.whitelist)return t;return r.pick.call(null,t,this.whitelist)},_blacklist:function(t){if(!this.blacklist)return t;return r.omit.call(null,t,this.blacklist)},_propertyMap:function(t){if(!this.propertyMap)return t;r.each(this.propertyMap,function(e,r){t[e]=t[r];delete t[r]});return t},_customAttributes:function(t){var e=this;var n={};var i=this.prepareProcedureMethods(r.functions(this.constructor.__protoProps__),{context:{item:t}});r.each(i,function(t){n[t._name]=t()});return n}});var p=e.Policy=u.extend({analyze:function(){return this.run.apply(this,arguments)},run:function(){var t=this;var e=this.prepareProcedureMethods(r.functions(this.constructor.__protoProps__),{context:r.pick.call(null,this,this.argumentNames)});var i=utilities.returnArrayOfResultsFromExecutedFunctions(e);return n.allSettled(i).then(this.parseResults)},prepareProcedureMethods:function(t,e){e=e||{};var r;r=utilities.getObjectMethodsByName(t,this);r=utilities.wrapAnySyncFunctionsWithBooleanPromiseHandling(r,e.context||this,e);r=utilities.wrapAnySequenceFunctionsThatRequestedPromises(r,e.context||this,{sequence:false,reject:function(t,e){return function(r){return e({name:t._name,error:r})}}});r=utilities.returnBoundObjectMethods(r,e.context||this);return r},parseResults:function(t){var e=n.defer();var i=t[0];var u=r.chain(t).filter(function(t){return t.state==="rejected"}).map(function(t){return t.reason}).value();if(u.length>0){e.reject(u)}else{e.resolve(this.arguments)}return e.promise}});function m(t,e){var n=this;var i;if(t&&r.has(t,"constructor")){i=t.constructor}else{i=function(){return n.apply(this,arguments)}}r.extend(i,n,e);var u=function(){this.constructor=i};u.prototype=n.prototype;i.prototype=new u;if(t)r.extend(i.prototype,t);i.__super__=n.prototype;i.__protoProps__=t;return i}r.each([s,a,c,l,h,f,p,Decorator],function(t){t.extend=m});function v(t,e){e=e||{};var r;r=utilities.getObjectMethodsByName(t,this,e);r=utilities.wrapAnySequenceFunctionsThatRequestedPromises(r,e.context||this,e);r=utilities.returnBoundObjectMethods(r,e.context||this,e);return r}function d(t,e){return t.reduce(function(t,e){return t.then(e)},e?n(e):n.when())}function y(t,e,i,u){u=u||{};var s=r.wrap(t,function(t){var r=n.defer();var s=u.resolve?u.resolve(t,r.resolve):r.resolve;var o=u.reject?u.reject(t,r.reject):r.reject;e=e.concat([s,o]);t.apply(i,e);return r.promise});return s}function _(t,e,i){i=i||{};return r.chain(t).compact().map(function(t){if(t.length===0){return function(){var r=n.defer();if(t.call(e)===true)r.resolve();else r.reject({name:t._name});return r.promise}}else{return t}}).value()}function g(t,e){t._name=e._name}function x(t,e,n){var i=this;n=n||{};return r.chain(t).compact().map(function(t,r){var u=function(u){var s=[];if(r>=1&&n.sequence!==false||r===0&&n.firstMethodTakesArgument===true)s.push(u);if(r===0&&n.firstMethodTakesArgument!==true&&t.length>=1||r>=1&&t.length>=2){t=i.wrapWithPromise(t,s,e,n)}return t.apply(e,s)};i.scopeName(u,t);return u}).value()}function b(t){return r.map(t,function(t){return t()})}function N(t,e){return r.map(t,function(t){var r=e[t];if(r){r._name=t}return r})}function j(t,e){var n=this;return r.chain(t).compact().map(function(t){var i=r.bind(t,e);n.scopeName(i,t);return i}).value()}function M(t){return r.map(t,function(t){return r.memoize(t)})}return e});
//# sourceMappingURL=dist/utensils-min.map